#!/usr/bin/env node
import { execSync } from 'node:child_process';
import { readFileSync, writeFileSync } from 'node:fs';

const [, , commitMsgPath, commitSource] = process.argv;

if (!commitMsgPath || commitSource === 'merge') {
  process.exit(0);
}

const existingMessage = (() => {
  try {
    return readFileSync(commitMsgPath, 'utf8');
  } catch {
    return '';
  }
})();

const hasUserContent = existingMessage.split('\n').some((line) => {
  const trimmed = line.trim();
  return trimmed.length > 0 && !trimmed.startsWith('#');
});

if (hasUserContent) {
  process.exit(0);
}

const stagedFiles = (() => {
  try {
    const output = execSync('git diff --cached --name-only', { encoding: 'utf8' }).trim();
    return output.length ? output.split('\n').filter(Boolean) : [];
  } catch {
    return [];
  }
})();

if (!stagedFiles.length) {
  process.exit(0);
}

function inferScope(filePath) {
  const [first, second] = filePath.split('/');
  if (!first) {
    return 'repo';
  }
  if (!second) {
    return first.replace(/\W+/g, '-');
  }
  if (first === 'src') {
    return (second || 'src').replace(/\W+/g, '-');
  }
  return first.replace(/\W+/g, '-');
}

function buildSubject(files) {
  const scope = inferScope(files[0]);
  const primaryFile = files[0].split('/').pop() ?? files[0];
  const descriptor = files.length === 1 ? primaryFile : `${files.length} files`;
  return `chore(${scope}): update ${descriptor}`;
}

const subject = buildSubject(stagedFiles);
const summaryLines = stagedFiles.slice(0, 5).map((file) => `- ${file}`);
if (stagedFiles.length > 5) {
  summaryLines.push(`- ...and ${stagedFiles.length - 5} more files`);
}

const autogeneratedMessage = `${subject}\n\n${summaryLines.join('\n')}\n`;

writeFileSync(commitMsgPath, autogeneratedMessage);
